<!--
doc/src/sgml/ref/pg_dumpall.sgml
PostgreSQL documentation
-->

<refentry id="APP-PG-DUMPALL">
 <indexterm zone="app-pg-dumpall">
  <primary>pg_dumpall</primary>
 </indexterm>
 
 <refmeta>
  <refentrytitle><application>pg_dumpall</application></refentrytitle>
  <manvolnum>1</manvolnum>
  <refmiscinfo>Application</refmiscinfo>
 </refmeta>

 <refnamediv>
  <refname>pg_dumpall</refname>
  <refpurpose>将一个<productname>PostgreSQL</productname>数据库集簇抽取到一个脚本文件中</refpurpose>
 </refnamediv>

 <refsynopsisdiv>
  <cmdsynopsis>
   <command>pg_dumpall</command>
   <arg rep="repeat"><replaceable>connection-option</replaceable></arg>
   <arg rep="repeat"><replaceable>option</replaceable></arg>
  </cmdsynopsis>
 </refsynopsisdiv>

 <refsect1 id="app-pg-dumpall-description">
  <title>描述</title>

  <para>
   <application>pg_dumpall</application>工具可以一个集簇中所有的<productname>PostgreSQL</>数据库写出到（<quote>转储</quote>）一个脚本文件。该脚本文件包含可以用作<xref linkend="app-psql">的输入<acronym>SQL</acronym>命令来恢复数据库。它会对集簇中的每个数据库调用<xref linkend="app-pgdump">来完成该工作。<application>pg_dumpall</application>还转储对所有数据库公用的全局对象（<xref linkend="app-pgdump">不保存这些对象）。 目前这包括适数据库用户和组、表空间以及适合所有数据库的访问权限等属性。
  </para>

  <para>
   因为<application>pg_dumpall</application>从所有数据库中读取表，所以你很可能需要以一个数据库超级用户的身份连接以便生成完整的转储。同样，你也需要超级用户特权执行保存下来的脚本，这样才能增加用户和组以及创建数据库。
  </para>

  <para>
   SQL 脚本将被写出到标准输出。使用 [-f|file] 选项或者 shell 操作符可以把它重定向到一个文件。
  </para>

  <para>
  <application>pg_dumpall</application>需要多次连接到<productname>PostgreSQL</productname>服务器（每个数据库一次）。如果你使用口令认证，可能每次都会要求口令。这种情况下使用一个<filename>~/.pgpass</>会比较方便。详见<xref linkend="libpq-pgpass">。
  </para>

 </refsect1>

 <refsect1>
  <title>选项</title>

   <para>
    下列命令行选项用于控制输出的内容和格式。

    <variablelist>
     <varlistentry>
      <term><option>-a</></term>
      <term><option>--data-only</></term>
      <listitem>
       <para>
        只转储数据，不转储模式（数据定义）。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-c</option></term>
      <term><option>--clean</option></term>
      <listitem>
       <para>
        包括在重建数据库之前清除（移除）它们的 SQL 命令。角色和表空间的<command>DROP</>命令也会被加入进来。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-f <replaceable class="parameter">filename</replaceable></option></term>
      <term><option>--file=<replaceable class="parameter">filename</replaceable></option></term>
      <listitem>
       <para>
        将输出发送到指定的文件中。如果省略，将使用标准输出。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-g</option></term>
      <term><option>--globals-only</option></term>
      <listitem>
       <para>
        只转储全局对象（角色和表空间），而不转储数据库。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-i</></term>
      <term><option>--ignore-version</></term>
      <listitem>
       <para>
        一个废弃选项，现在会被忽略。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-o</></term>
      <term><option>--oids</></term>
      <listitem>
       <para>
        将对象标识符（<acronym>OID</acronym>）转储为数据的一部分。如果你的应用以某种方式引用<acronym>OID</>列（例如在外键约束中），请使用这个选项。否则不应该使用这个选项。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-O</></term>
      <term><option>--no-owner</option></term>
      <listitem>
       <para>
        不输出用于设置对象所有权以符合原始数据库的命令。默认情况下，<application>pg_dumpall</application>发出<command>ALTER OWNER</>或<command>SET SESSION AUTHORIZATION</command>语句来设置被创建的模式元素的所有权。除非脚本是由一个超级用户（或者是拥有脚本中所有对象的同一个用户）所运行，这些语句在脚本运行时会失败。要使得一个脚本能被任意用户恢复，但又不想给予该用户所有对象的所有权，可以指定<option>-O</>。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-r</option></term>
      <term><option>--roles-only</option></term>
      <listitem>
       <para>
        只转储角色，不转储数据库和表空间。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-s</option></term>
      <term><option>--schema-only</option></term>
      <listitem>
       <para>
        只转储对象定义（模式），不转储数据。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-S <replaceable class="parameter">username</replaceable></option></term>
      <term><option>--superuser=<replaceable class="parameter">username</replaceable></option></term>
      <listitem>
       <para>
        指定要在禁用触发器时使用的超级用户的用户名。只有使用<option>--disable-triggers</>时，这个选项才相关（通常，最好省去这个选项，而作为超级用户来启动结果脚本来取而代之）。
        Specify the superuser user name to use when disabling triggers.
        This is relevant only if <option>--disable-triggers</> is used.
        (Usually, it's better to leave this out, and instead start the
        resulting script as superuser.)
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-t</option></term>
      <term><option>--tablespaces-only</option></term>
      <listitem>
       <para>
        只转储表空间，不转储数据库和角色。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-v</></term>
      <term><option>--verbose</></term>
      <listitem>
       <para>
        指定细节模式。这将导致<application>pg_dumpall</application>向标准错误输出详细的对象注释以及转储文件的开始/停止时间，还有进度消息。它也会启用<application>pg_dump</>中的细节输出。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
       <term><option>-V</></term>
       <term><option>--version</></term>
       <listitem>
       <para>
       打印<application>pg_dumpall</application>版本并退出。
       </para>
       </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-x</></term>
      <term><option>--no-privileges</></term>
      <term><option>--no-acl</></term>
      <listitem>
       <para>
        防止转储访问特权（授予/收回命令）。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--binary-upgrade</option></term>
      <listitem>
       <para>
        这个选项用于就地升级功能。我们不推荐也不支持把它用于其他目的。这个选项在未来的发行中可能被改变而不做通知。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--column-inserts</option></term>
      <term><option>--attribute-inserts</option></term>
      <listitem>
       <para>
        将数据转储为带有显式列名的<command>INSERT</command>命令（<literal>INSERT INTO <replaceable>table</replaceable>(<replaceable>column</replaceable>, ...) VALUES ...</literal>）。这将使得恢复过程非常慢，这主要用于使转储能够被载入到非<productname>PostgreSQL</productname>数据库中。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--disable-dollar-quoting</></term>
      <listitem>
       <para>
        这个选项禁止在函数体中使用美元符号引用，并且强制它们使用 SQL 标准字符串语法被引用。
       </para>
     </listitem>
    </varlistentry>

     <varlistentry>
      <term><option>--disable-triggers</></term>
      <listitem>
       <para>
        只有在创建一个只转储数据的转储时，这个选项才相关。它指示<application>pg_dumpall</application>包括在数据被重新载入时能够临时禁用目标表上的触发器的命令。如果你在表上有引用完整性检查或其他触发器，并且你在数据重新载入期间不想调用它们，请使用这个选项。
       </para>

       <para>
        当前，为<option>--disable-triggers</>发出的命令必须作为超级用户来执行。因此，你还应当使用<option>-S</>指定一个超级用户名，或者宁可作为一个超级用户启动结果脚本。
       </para>
      </listitem>
     </varlistentry>
     
     <varlistentry>
      <term><option>--if-exists</option></term>
      <listitem>
       <para>
        时间条件性命令（即增加一个<literal>IF EXISTS</literal>子句）来清除数据库和其他对象。
        只有同时指定了<option>--clean</>时，这个选项才可用。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--inserts</option></term>
      <listitem>
       <para>
        将数据转储为<command>INSERT</command>命令（而不是<command>COPY</command>）。这将使得恢复非常慢，这主要用于使转储能够被载入到非<productname>PostgreSQL</productname>数据库中。注意如果你已经重新安排了列序，该恢复可能会一起失败。<option>--column-inserts</option>选项对于列序改变是安全的，但是会更慢。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--lock-wait-timeout=<replaceable class="parameter">timeout</replaceable></option></term>
      <listitem>
       <para>
        在转储的开始从不等待共享表锁的获得。而是在指定的<replaceable class="parameter">timeout</>内不能锁定一个表时失败。超时时长可以用<command>SET statement_timeout</>接受的任何格式指定（允许的值根据你从其转出的服务器版本变化，但是从 7.3 以来的所有版本都接受一个整数表示的毫秒数。如果从 7.3 以前的服务器转出，这个选项会被忽略。）。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--no-security-labels</option></term>
      <listitem>
       <para>
        不转储安全标签。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--no-tablespaces</option></term>
      <listitem>
       <para>
        不要输出选择表空间的命令。通过这个选项，在恢复期间所有的对象都会被创建在任何作为默认的表空间中。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--no-unlogged-table-data</option></term>
      <listitem>
       <para>
        不转储非日志记录表的内容。这个选项对于表定义（模式）是否被转储没有影响，它只会限制转储表数据。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--quote-all-identifiers</></term>
      <listitem>
       <para>
        强制引用所有标识符。当为了迁移到一个可能会引入额外关键词的未来版本进行转储时，这个选项很有用。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--use-set-session-authorization</></term>
      <listitem>
       <para>
        输出 SQL-标准的<command>SET SESSION AUTHORIZATION</>命令取代<command>ALTER OWNER</>命令来确定对象的所有关系。这让该转储更加兼容标准，但是取决于该转储中对象的历史，该转储可能无法正常恢复。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
       <term><option>-?</></term>
       <term><option>--help</></term>
       <listitem>
       <para>
       显示有关<application>pg_dumpall</application>命令行参数的帮助并退出。
       </para>
       </listitem>
     </varlistentry>

    </variablelist>
   </para>

  <para>
   下列命令行选项控制数据库连接参数。

   <variablelist>
     <varlistentry>
      <term><option>-d <replaceable class="parameter">connstr</replaceable></option></term>
      <term><option>--dbname=<replaceable class="parameter">connstr</replaceable></option></term>
      <listitem>
       <para>
        以一个连接字符串的形式，指定用来连接到服务器的参数。详见<xref linkend="libpq-connstring">。
       </para>
       <para>
        这个选项被称为<literal>--dbname</>是为了和其他客户端应用一致，但是因为<application>pg_dumpall</application>需要连接多个数据库，连接字符串中的数据库名将被忽略。使用<literal>-l</literal>选项指定一个数据库，该数据库被用来转储全局对象并且发现需要转储哪些其他数据库。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-h <replaceable>host</replaceable></option></term>
      <term><option>--host=<replaceable>host</replaceable></option></term>
      <listitem>
       <para>
        指定服务器正在运行的机器的主机名。如果该值开始于一个斜线，它被用作一个 Unix 域套接字的目录。默认是从<envar>PGHOST</envar>环境变量中取得（如果被设置），否则将尝试一次 Unix 域套接字连接。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-l <replaceable>dbname</replaceable></option></term>
      <term><option>--database=<replaceable>dbname</replaceable></option></term>
      <listitem>
       <para>
         指定要连接到哪个数据库转储全局对象以及发现要转储哪些其他数据库。如果没有指定，将会使用<literal>postgres</literal>数据库，如果<literal>postgres</literal>不存在，就使用 <literal>template1</literal>。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-p <replaceable>port</replaceable></option></term>
      <term><option>--port=<replaceable>port</replaceable></option></term>
      <listitem>
       <para>
        指定服务器正在监听连接的 TCP 端口或本地 Unix 域套接字文件扩展名。默认是放在<envar>PGPORT</envar>环境变量中（如果被设置），否则使用编译在程序中的默认值。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-U <replaceable>username</replaceable></option></term>
      <term><option>--username=<replaceable>username</replaceable></option></term>
      <listitem>
       <para>
        要作为哪个用户连接。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-w</></term>
      <term><option>--no-password</></term>
      <listitem>
       <para>
        从不发出一个口令提示。如果服务器要求口令认证并且没有其他方式提供口令（例如一个<filename>.pgpass</filename>文件），那儿连接尝试将失败。这个选项对于批处理任务和脚本有用，因为在其中没有一个用户来输入口令。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>-W</option></term>
      <term><option>--password</option></term>
      <listitem>
       <para>
        强制<application>pg_dumpall</application>在连接到一个数据库之前提示要求一个口令。
       </para>

       <para>
        这个选项从来不是必须的，因为如果服务器要求口令认证，<application>pg_dumpall</application>将自动提示要求一个口令。但是，<application>pg_dumpall</application>将浪费一次连接尝试来发现服务器想要一个口令。在某些情况下，值得键入<option>-W</>来避免额外的连接尝试。
       </para>

       <para>
        注意对每个要被转储的数据库，口令提示都会再次出现。通常，最好设置一个<filename>~/.pgpass</>文件来减少手工口令输入。
       </para>
      </listitem>
     </varlistentry>

     <varlistentry>
      <term><option>--role=<replaceable class="parameter">rolename</replaceable></option></term>
      <listitem>
       <para>
        指定一个用来创建该转储的角色名。这个选项导致<application>pg_dump</>在连接到数据库后发出一个<command>SET ROLE</> <replaceable class="parameter">rolename</>命令。当已认证用户（由<option>-U</>指定）缺少<application>pg_dump</>所需的特权但是能够切换到一个具有所需权利的角色时，这个选项很有用。一些安装有针对直接作为超级用户登录的策略，使用这个选项可以让转储在不违反该策略的前提下完成。
       </para>
      </listitem>
     </varlistentry>
   </variablelist>
  </para>
 </refsect1>


 <refsect1>
  <title>环境</title>

  <variablelist>
   <varlistentry>
    <term><envar>PGHOST</envar></term>
    <term><envar>PGOPTIONS</envar></term>
    <term><envar>PGPORT</envar></term>
    <term><envar>PGUSER</envar></term>

    <listitem>
     <para>
      默认连接参数
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   和大部分其他<productname>PostgreSQL</>工具相似，这个工具也使用<application>libpq</>（见<xref linkend="libpq-envars">）支持的环境变量。
  </para>

 </refsect1>


 <refsect1>
  <title>注解</title>

  <para>
   因为<application>pg_dumpall</application>在内部调用<application>pg_dump</application>，所以， 一些诊断消息可以参考<application>pg_dump</application>。
  </para>

  <para>
   一旦恢复，建议在每个数据库上运行<command>ANALYZE</>，这样优化器就可以得到有用的统计信息。你也可以运行<command>vacuumdb -a -z</>来分析所有数据库。
  </para>

  <para>
   <application>pg_dumpall</application>要求所有需要的表空间目录在进行恢复之前就必须存在；否则，数据库创建就会由于在非默认位置创建数据库而失败。
  </para>
 </refsect1>


 <refsect1 id="app-pg-dumpall-ex">
  <title>例子</title>
  <para>
   要转储所有数据库：

<screen>
<prompt>$</prompt> <userinput>pg_dumpall &gt; db.out</userinput>
</screen>
  </para>

  <para>
   要从这个文件重新载入数据库，你可以使用：
<screen>
<prompt>$</prompt> <userinput>psql -f db.out postgres</userinput>
</screen>
   （这里你连接哪一个数据库并不重要，因为由<application>pg_dumpall</application>创建的脚本将包含合适的命令来创建和连接到被保存的数据库）。
  </para>
 </refsect1>

 <refsect1>
  <title>参见</title>

  <para>
    可能的错误情况请查看<xref linkend="app-pgdump">。
  </para>
 </refsect1>

</refentry>
